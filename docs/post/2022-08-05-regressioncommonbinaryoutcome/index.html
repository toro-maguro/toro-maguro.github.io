<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Sacoche">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://toro-maguro.github.io/img/home-bg-jeep.jpg">
    <meta property="twitter:image" content="https://toro-maguro.github.io/img/home-bg-jeep.jpg" />
    

    
    <meta name="title" content="稀でない2値イベントに対する回帰モデル" />
    <meta property="og:title" content="稀でない2値イベントに対する回帰モデル" />
    <meta property="twitter:title" content="稀でない2値イベントに対する回帰モデル" />
    

    
    <meta name="description" content="Epidemiology, Statistical modeling, data infrastructure, and data viz">
    <meta property="og:description" content="Epidemiology, Statistical modeling, data infrastructure, and data viz" />
    <meta property="twitter:description" content="Epidemiology, Statistical modeling, data infrastructure, and data viz" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="Epidemiology, IT, cloud">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>稀でない2値イベントに対する回帰モデル | Sacoche</title>

    <link rel="canonical" href="/post/2022-08-05-regressioncommonbinaryoutcome/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Sacoche</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/epidemiology">epidemiology</a>
                        </li>
                        
                        <li>
                            <a href="/categories/others">others</a>
                        </li>
                        
                        <li>
                            <a href="/categories/%E8%87%AA%E4%BD%9C%E9%96%A2%E6%95%B0">自作関数</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/archive/">ARCHIVE</a></li>
                    
                        <li><a href="/about/">ABOUT</a></li>
                    

                    
		    <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/home-bg-jeep.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/epidemiology" title="Epidemiology">
                            Epidemiology
                        </a>
                        
                    </div>
                    <h1>稀でない2値イベントに対する回帰モデル</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                    Sacoche
                             
                            on 
                            Thursday, January 20, 2022
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                
<script src="https://toro-maguro.github.io/post/2022-08-05-regressioncommonbinaryoutcome/index_files/header-attrs/header-attrs.js"></script>


<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({
 tex2jax: {
 inlineMath: [['$', '$'] ],
 displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
 }
 });
</script>
<div id="はじめに" class="section level1">
<h1>はじめに</h1>
<ul>
<li>Question: <strong>研究参加者の約50％で発生しているbinaryのイベントをモデリングしたい。どんな手法を使えばよいだろうか？</strong></li>
<li>問題意識: 思考停止の「ロジスティック回帰」はまずいかもしれない。オッズ比とリスク比の乖離が起こりうる。</li>
</ul>
<p>共著の論文でこうした問題に出会ったので、そこでの勉強内容をシェアします。(要は<a href="https://toro-maguro.github.io/post/2022-08-05-riskratio-vs-oddsratio/">前回</a>の続き)</p>
<p>(2022/8/5追記: 関数を使わない書き方をしていたので、いくつか編集しました)</p>
<div id="まとめると" class="section level2">
<h2>まとめると…</h2>
<ul>
<li>リスク比が1より大きく、2値のイベントの発生割合が大きい場合、<strong>オッズ比はリスク比よりも大きくなる</strong></li>
<li>オッズ比よりもリスク比の方が疫学的な関心が高いので、オッズ比とリスク比の乖離は問題となる。したがって、<strong>イベントが多い状況でロジスティック回帰を用いることは、慎重に考えるべき</strong>。</li>
<li><strong>修正ポアソン回帰とlog-binomial regression (対数二項回帰)</strong> が代替候補。</li>
</ul>
<p>リスク比とオッズ比が乖離する様子を細かく知りたい方は、まずこちらをお読みください。<br/>
<a href="https://toro-maguro.github.io/post/2022-08-05-riskratio-vs-oddsratio/">稀でないイベントにおけるリスク比とオッズ比</a></p>
</div>
</div>
<div id="準備" class="section level1">
<h1>準備</h1>
<pre class="r"><code>pacman::p_load(tidyverse, epiR, epitools)</code></pre>
<div id="データ作り" class="section level2">
<h2>データ作り</h2>
<p>自由にデータを操作できるように、このセクションで2×2表のデータを作っていきます。</p>
<p>デフォルトの設定は以下の通りです。</p>
<ul>
<li>N: 2000人</li>
<li>イベント発生割合: 50%</li>
<li>曝露群の割合: 25%</li>
<li>曝露のリスク比: 2.0倍</li>
<li>共変量として性別が存在する</li>
</ul>
<pre class="r"><code># データセットを作る関数
## n: 研究参加者数、p_event: イベント発生割合、p_exposure: 曝露群の割合、
## rr_exposure: 曝露によるリスク比 (横断研究なら有病率比ですが)、rr_sex: 女性の男性に対するリスク比
MakeData &lt;- function(n=2000, p_event=0.5, p_exposure=0.25, rr_exposure=2.0, rr_sex=0.5){
  set.seed(123)
  baseline_risk &lt;- n*p_event / (n*(1-p_exposure)+n*p_exposure*rr_exposure) # risk at non-exposed group
  ID &lt;- c(1:n)
  sex &lt;- c(rep(0, n*0.6), rep(1, n*0.4)) # male=0, female=1
  df &lt;- data.frame(ID = ID, sex = sex)

  df &lt;- df %&gt;% 
    mutate(exposure = rbinom(n = nrow(df), size = 1, prob = p_exposure-sex*0.15)) %&gt;% 
    mutate(risk = case_when(
      exposure == 0 &amp; sex == 0 ~ baseline_risk,
      exposure == 0 &amp; sex == 1 ~ baseline_risk*rr_sex,
      exposure == 1 &amp; sex == 0 ~ baseline_risk*rr_exposure,
      exposure == 1 &amp; sex == 1 ~ baseline_risk*rr_exposure*rr_sex
    )) %&gt;% 
    mutate(outcome = rbinom(n = nrow(df), size = 1, prob = risk))
  
  df &lt;- select(df, ID, sex, exposure, outcome)
  
  return(df)
}

df &lt;- MakeData()</code></pre>
<p>作成したデータセットはこの通りです。上から3行だけ提示しますが、指定した人数分入っています。</p>
<pre class="r"><code># データセットの確認
head(df, 3)</code></pre>
<pre><code>##   ID sex exposure outcome
## 1  1   0        0       0
## 2  2   0        1       1
## 3  3   0        0       0</code></pre>
<p>イベント発生割合は0.39になりました。
(乱数の関係上、指定した値ぴったりではない)</p>
<pre class="r"><code># イベント発生割合の確認
mean(df$outcome)</code></pre>
<pre><code>## [1] 0.3895</code></pre>
</div>
<div id="データのチェック" class="section level2">
<h2>データのチェック</h2>
<p>データを整理しつつ、効果の指標を確認します。</p>
<pre class="r"><code>tab &lt;- xtabs(~ exposure + outcome + sex, data = df)

# epi.2by2で扱えるように変換...このあたり、詳しく知らないのでコードが汚い
men &lt;- matrix(c(tab[2,2,1], tab[2,1,1], tab[1,2,1], tab[1,1,1]),
              nrow = 2, byrow = TRUE)
women &lt;- matrix(c(tab[2,2,2], tab[2,1,2], tab[1,2,2], tab[1,1,2]),
              nrow = 2, byrow = TRUE)
dat &lt;- array(c(men, women), dim = c(2,2,2))

crosstable &lt;- epi.2by2(dat, method = &quot;cohort.count&quot;)
crosstable</code></pre>
<pre><code>##              Outcome +    Outcome -      Total        Inc risk *        Odds
## Exposed +          250          113        363              68.9       2.212
## Exposed -          529         1108       1637              32.3       0.477
## Total              779         1221       2000              39.0       0.638
## 
## 
## Point estimates and 95% CIs:
## -------------------------------------------------------------------
## Inc risk ratio (crude)                         2.13 (1.93, 2.35)
## Inc risk ratio (M-H)                           1.88 (1.70, 2.07)
## Inc risk ratio (crude:M-H)                     1.14
## Odds ratio (crude)                             4.63 (3.63, 5.92)
## Odds ratio (M-H)                               3.99 (3.10, 5.14)
## Odds ratio (crude:M-H)                         1.16
## Attrib risk in the exposed (crude) *           36.56 (31.28, 41.83)
## Attrib risk in the exposed (M-H) *             31.71 (17.31, 46.11)
## Attrib risk (crude:M-H)                        1.15
## -------------------------------------------------------------------
##  M-H test of homogeneity of PRs: chi2(1) = 0.031 Pr&gt;chi2 = 0.860
##  M-H test of homogeneity of ORs: chi2(1) = 3.323 Pr&gt;chi2 = 0.068
##  Test that M-H adjusted OR = 1:  chi2(1) = 122.411 Pr&gt;chi2 = &lt;0.001
##  Wald confidence limits
##  M-H: Mantel-Haenszel; CI: confidence interval
##  * Outcomes per 100 population units</code></pre>
<p>デフォルトの設定 (Mantel-Haenszel) だと、効果の指標は次のとおりです。
<strong>リスク比とオッズ比との間に大きな乖離がありますね</strong>。</p>
<ul>
<li><strong>risk ratio: 1.88 [95%CI: 1.70-2.07]</strong></li>
<li><strong>odds ratio: 3.99 [95%CI: 3.10-5.14]</strong></li>
</ul>
</div>
</div>
<div id="odds-ratio-vs-risk-ratio" class="section level1">
<h1>Odds ratio vs Risk ratio</h1>
<p><a href="http://torutsuboya.blogspot.com/2016/03/orrr.html">こちらのブログ</a>の指摘はなかなか的を射ていると感じます。</p>
<blockquote>
<p>prevalenceが10％を超えると、ORが「X倍」に近似できないのはその通りだと思うが、ORはORのままで議論すればよい（例：ORが2倍でした、などと記述すればよい）気がしていた。
relative riskの議論に持ち込まなければORで議論しても問題ない気がするが、それで議論を進めて何かまずいものでしょうか。</p>
</blockquote>
<p>しかしながら、<strong>疫学の流れを考えればrisk differenceやrisk ratioが根本にあり、odds ratioは代替的に使うものと考えることが自然でしょう</strong>。したがって、<strong>ORがrisk ratioを大きく超える (exaggerate) 状況なのであれば、効果や関連の指標としてORを使うことはあまり望ましくないと考えられます</strong>。
(i.e. イベントの発生が稀でない、など)</p>
<p>ということで、可能ならオッズ比ではなくリスク比を評価していきたい、ということが今後の流れです。</p>
<p><br/n></p>
</div>
<div id="回帰分析による推定" class="section level1">
<h1>回帰分析による推定</h1>
<p>さきほどの2×2表での計算で分析が済むなら楽なのですが、実際の研究では回帰分析を使うことの方が多いと思います。
そこで今回は、どのような回帰分析手法を使えばよいのか？という課題を取り上げます。</p>
<div id="ロジスティック回帰" class="section level2">
<h2>ロジスティック回帰</h2>
<p>はじめに、頻繁に使われているなロジスティック回帰について。
これはオッズ比を導くので、今回の状況ではあまり望ましくない分析手法となります。</p>
<pre class="r"><code>logistic &lt;- glm(outcome ~ exposure + sex, data = df, family = binomial(link = &quot;logit&quot;))
summary(logistic)</code></pre>
<pre><code>## 
## Call:
## glm(formula = outcome ~ exposure + sex, family = binomial(link = &quot;logit&quot;), 
##     data = df)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.6204  -1.0265  -0.6963   1.3362   1.7527  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -0.36578    0.06564  -5.573 2.51e-08 ***
## exposure     1.36527    0.12794  10.671  &lt; 2e-16 ***
## sex         -0.92773    0.10395  -8.924  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 2674.1  on 1999  degrees of freedom
## Residual deviance: 2427.2  on 1997  degrees of freedom
## AIC: 2433.2
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<pre class="r"><code>exp(coef(logistic)) # OR</code></pre>
<pre><code>## (Intercept)    exposure         sex 
##   0.6936556   3.9167791   0.3954505</code></pre>
<pre class="r"><code>exp(confint(logistic)) # 95%CI</code></pre>
<pre><code>##                 2.5 %    97.5 %
## (Intercept) 0.6096078 0.7885442
## exposure    3.0549176 5.0462776
## sex         0.3221285 0.4842474</code></pre>
</div>
<div id="ポアソン回帰" class="section level2">
<h2>ポアソン回帰</h2>
<div id="通常のポアソン回帰" class="section level3">
<h3>通常のポアソン回帰</h3>
<p>一般に、ポアソン回帰は0以上の整数値を取るデータに対して適用される回帰モデルで、特に「稀なイベント」に使われています。
例えば、交差点での交通事故発生件数や製品製造ラインでの故障品などが代表的でしょうか。
また、故障品のモデリングなど「全体でいくつ作っているか」も重要になる場合は、
<strong>オフセット項</strong>を導入することで、割合もモデリングすることが可能になります。<a href="https://www.jstage.jst.go.jp/article/weed/55/4/55_4_287/_pdf">FYI: J-Stageの解説論文</a></p>
<p>また、ポアソン回帰は<strong>0/1のbinary outcomeに対しても適用することができます</strong>。
イメージする上では、<a href="https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/1471-2288-8-9">Petersen, et al. 2008</a>のフレーズがわかりやすいように感じます。</p>
<blockquote>
<p>It is well known that when the prevalence is low and the sample size is large, probabilities from the Poisson distribution can often be used to approximate probabilities from the binomial distribution. Similarly, <strong>one can think of an existing sample of binomial data (0 or 1) as being approximately Poisson, where the probability of a value of 2 or greater is low enough that no values greater than 1 occurred in the obtained sample</strong>.</p>
</blockquote>
<p>もし、ポアソン回帰をbinary outcomeに対して用いる場合は、<a href="https://pubmed.ncbi.nlm.nih.gov/15033648/">Zou, 2004</a>を引用すると良さげです (鉄板論文らしい)。
それでは、実際にすすめていきます。まずは通常のポアソン回帰から。</p>
<pre class="r"><code>poisson &lt;- glm(outcome ~ exposure + sex, data = df, family = poisson(link = &quot;log&quot;))
summary(poisson)</code></pre>
<pre><code>## 
## Call:
## glm(formula = outcome ~ exposure + sex, family = poisson(link = &quot;log&quot;), 
##     data = df)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.2286  -0.8966  -0.6704   0.7917   1.1979  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -0.91140    0.05074 -17.960  &lt; 2e-16 ***
## exposure     0.62997    0.07837   8.038 9.14e-16 ***
## sex         -0.58137    0.08460  -6.872 6.34e-12 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 1469.0  on 1999  degrees of freedom
## Residual deviance: 1330.6  on 1997  degrees of freedom
## AIC: 2894.6
## 
## Number of Fisher Scoring iterations: 5</code></pre>
<pre class="r"><code>exp(coef(poisson)) # risk ratio</code></pre>
<pre><code>## (Intercept)    exposure         sex 
##   0.4019608   1.8775456   0.5591328</code></pre>
<pre class="r"><code>exp(confint(poisson)) # 95%CI, basic poisson regression</code></pre>
<pre><code>##                 2.5 %    97.5 %
## (Intercept) 0.3633534 0.4433375
## exposure    1.6080557 2.1867087
## sex         0.4726644 0.6586717</code></pre>
<p>ここで注目していただきたいポイントは信頼区間です。
今回のポアソン回帰では、<strong>RR = 1.88 [95%CI: 1.61-2.19]</strong> となりました。</p>
<p>一方、2×2表で得たリスク比は <strong>1.88 [95%CI: 1.70-2.07] であり、ポアソン回帰で得た信頼区間の幅の方が大きくなっています</strong>。</p>
<p>ここが、Zou (2004) の言うところの “<strong>On the other hand, use of Poisson regression tends to provide conservative results</strong>”
にあたるのでしょう。</p>
</div>
<div id="ロバスト分散を使った修正ポアソン回帰" class="section level3">
<h3>ロバスト分散を使った修正ポアソン回帰</h3>
<p>そこで、Zouの手法による修正ポアソン回帰のロバスト分散の計算を実行します。<br/n>
参考1: <a href="https://charliemarks.com/r-tutorials/modifiedpoissonregression">Zou’s Modified Poisson Regression</a>,
参考2: <a href="https://rpubs.com/kaz_yos/ku-r3">いろいろ情報盛りだくさん</a></p>
<pre class="r"><code>pacman::p_load(lmtest, sandwich)

modified_poiss &lt;- coeftest(poisson, vcov = sandwich)</code></pre>
<p>係数は同じですね。一方、標準誤差は随分違います。修正ポアソン回帰の方が、小さな標準誤差を得ることに成功しました。</p>
<pre class="r"><code>modified_poiss # 修正ポアソン回帰</code></pre>
<pre><code>## 
## z test of coefficients:
## 
##              Estimate Std. Error  z value  Pr(&gt;|z|)    
## (Intercept) -0.911401   0.039205 -23.2469 &lt; 2.2e-16 ***
## exposure     0.629965   0.050511  12.4718 &lt; 2.2e-16 ***
## sex         -0.581368   0.070023  -8.3025 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>では、修正ポアソン回帰に基づく信頼区間を計算します。
面倒なことに、自分で計算をしなくてはならないようです。</p>
<pre class="r"><code>GetConfint &lt;- function(res_coeftest, siglevel=0.05, digits=4){
  temp &lt;- exp(cbind(
    RiskRatio = res_coeftest[,1], 
    LowerCI = res_coeftest[,1] + qnorm(siglevel/2)*res_coeftest[,2],
    UpperCI = res_coeftest[,1] - qnorm(siglevel/2)*res_coeftest[,2]
  ))
  p_value &lt;- res_coeftest[,4]
  
  result &lt;- cbind(temp, p_value = p_value)
  result &lt;- round(result, digits)
  
  return(result)
}

GetConfint(modified_poiss)</code></pre>
<pre><code>##             RiskRatio LowerCI UpperCI p_value
## (Intercept)    0.4020  0.3722  0.4341       0
## exposure       1.8775  1.7006  2.0729       0
## sex            0.5591  0.4874  0.6414       0</code></pre>
<p>2×2表で得たリスク比は <strong>1.88 [95%CI: 1.70-2.07]</strong> ですから、<strong>通常のポアソン回帰で得た1.88 [95%CI: 1.61-2.19]よりも狭い信頼区間を得ることができました</strong>。</p>
<p>※ 2×2表に戻るなら→ <a href="#データのチェック">データのチェック</a></p>
<p><br/n></p>
</div>
</div>
<div id="log-binomial" class="section level2">
<h2>log-binomial</h2>
<p>log binomialの回帰について、勉強することは初めてのことです。そこで、モデルの式も含めて記していきます。</p>
<div id="モデル式" class="section level3">
<h3>モデル式</h3>
<p>GLM族なので、a) 線形予測子、b) リンク関数、c) 確率分布の3つで記述することができます。<br/n>
やっていきましょう。</p>
<p>log-binomial regressionのモデルは以下の通りです（説明変数が2つとします）。<br/n>
参考: <a href="https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-018-0519-5">Chen, et al. 2018</a></p>
<p><span class="math display">\[\log{(p_i)} = b_0 +b_1x_{i1}+b_2x_{i2} \]</span>
<span class="math display">\[y_i \sim Binomial(n, p_i)\]</span></p>
<p>ただ、今回は個人が集計単位でy_iは0/1のみがアウトカムなので、n=1となります。<br/n>
(二項分布なので、コイン投げを1回するイメージですね)</p>
<p><br/n></p>
</div>
<div id="なぜlog" class="section level3">
<h3>なぜ”log”?</h3>
<p>ロジスティック回帰はとても良くできたモデルだと思います。</p>
<ul>
<li>解釈が比較的簡単</li>
<li>確率のシグモイド的な振る舞いを考えることができる（「ある閾値を超えるとイベントが起こる」といった考え方）</li>
<li>0≤p≤1の確率pに対し、0≤ p/(1-p) &lt;∞であり、log(p/(1-p))は負の無限大から無限大を取るので、被説明変数として適切</li>
</ul>
<p>そんな中log-binomialモデルでは、なぜlog(p)を考えるのでしょうか？
オッズではなく確率をモデルできることは強みです。
ただし、<strong>0≤p≤1の確率pに対し、log(p)は負の無限大から0を取るので、実数全体を取りうるわけではありません</strong>。ここがどうにも妙なところです。</p>
<p>この妙な点は、収束が難しいことも引き起こしてしまうようです。</p>
<blockquote>
<p>However, the Log link function in Log-Binomial models restricts the probabilities of an outcome to be greater than or equal to zero, that is, to fall within the bounds [0, ∞). Due to this mismatch between the bounds of the model and the allowable outcome, in practice, the Log-Binomial model will routinely fail to converge and will not provide the parameter estimates (Localio et al. 2007).</p>
</blockquote>
<p>(from: <a href="https://support.sas.com/resources/papers/proceedings11/345-2011.pdf">SAS</a>)</p>
<p>なんだか難しそうですが、とりあえずやってみましょう。</p>
</div>
<div id="log-binomial-regの実践" class="section level3">
<h3>log-binomial regの実践</h3>
<pre class="r"><code>logbin &lt;- glm(outcome ~ exposure + sex, data = df, family = binomial(link = &quot;log&quot;))

summary(logbin)</code></pre>
<pre><code>## 
## Call:
## glm(formula = outcome ~ exposure + sex, family = binomial(link = &quot;log&quot;), 
##     data = df)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.6735  -1.0139  -0.7141   1.3502   1.7271  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -0.91148    0.03919 -23.257   &lt;2e-16 ***
## exposure     0.62844    0.04974  12.635   &lt;2e-16 ***
## sex         -0.57996    0.06956  -8.338   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 2674.1  on 1999  degrees of freedom
## Residual deviance: 2423.8  on 1997  degrees of freedom
## AIC: 2429.8
## 
## Number of Fisher Scoring iterations: 6</code></pre>
<pre class="r"><code>exp(coef(logbin)) # risk ratio</code></pre>
<pre><code>## (Intercept)    exposure         sex 
##   0.4019306   1.8746794   0.5599207</code></pre>
<pre class="r"><code>exp(confint(logbin)) # 95%CI</code></pre>
<pre><code>##                 2.5 %    97.5 %
## (Intercept) 0.3714111 0.4331468
## exposure    1.6988379 2.0656133
## sex         0.4868184 0.6397534</code></pre>
<p>2×2表で得たリスク比は 1.88 [95%CI: 1.70-2.07] でしたから、普通にできてますね。</p>
<p>収束の問題が起こるのは、データが十分にない（サンプルサイズ・イベント数など）場合のようです。<a href="https://ete-online.biomedcentral.com/articles/10.1186/1742-7622-10-14">Williamson, et al. 2013</a></p>
<blockquote>
<p>Recently there was a paper published in Stroke [4], where in the statistical methods section the authors
indicated that: “As a first approach to the multivariable analysis, we used a log-binomial model, but
owing to the sparseness of data, this failed to converge.</p>
</blockquote>
<p>デフォルトの設定では、大きな問題にはなりませんでした。</p>
<p><br/n></p>
<div id="トラブルシューティング" class="section level4">
<h4>トラブルシューティング</h4>
<p>もし、以下のようなエラーで最尤推定の際の初期値を求められた場合、glm中のstartを設定することで前進できる可能性があります。</p>
<ul>
<li>Error: cannot find valid starting values: please specify some</li>
<li>エラー: 係数の有効なセットが見出されませんでした: 初期値を与えてください</li>
</ul>
<p><a href="https://stats.stackexchange.com/questions/105633/what-to-do-when-a-log-binomial-models-convergence-fails">参考1, 対応について</a>,
<a href="https://stats.stackexchange.com/questions/62460/what-are-starting-values-in-glm-function">参考2, 考え方について</a></p>
<p>考え方としては、「切片をlog(mean(y)), それ以外の係数を0にしよう！」ということです。構造モデルを考えれば、帰無仮説下H0の状況での考えを初期値としている、というイメージがつかめると思います。もちろん、「x_iが0のとき」という意味合いを考えて、適宜調整してくださいね。</p>
<p><span class="math display">\[\log{(p_i)} = b_0 +b_1x_{i1}+b_2x_{i2} \]</span></p>
<p>なお、上で紹介した参考1で述べられているコードには誤りがあります。<br/n>
startの引数として、“start=c(log(mean(y), rep(0, np-1))” とありますが、
“start = c(log(mean(y)), rep(0, np-1))”としましょう。
log(0)は負の無限大となってしまい、定義できないからです。（単純なミスでしょう）</p>
<p>先ほど実践したlog-binomial modelにstartの引数を指定すると、こんな形になります。
rep(0, np-1)のnpは切片を含む説明変数の数とありますが、factor型の説明変数を投入している場合は水準の数だけ増えてしまうことにも注意してください。</p>
<pre class="r"><code># startの引数設定
## 説明変数が切片と2つの因子 (曝露と性別) 
## したがって、切片用にlog(mean(y)), 投入した説明変数用にrep(0, 2)となる
logbin2 &lt;- glm(outcome ~ exposure + sex, data = df, family = binomial(link = &quot;log&quot;),
               start = c(log(mean(df$outcome)), rep(0, 2))) 


summary(logbin2)</code></pre>
<pre><code>## 
## Call:
## glm(formula = outcome ~ exposure + sex, family = binomial(link = &quot;log&quot;), 
##     data = df, start = c(log(mean(df$outcome)), rep(0, 2)))
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.6735  -1.0139  -0.7141   1.3502   1.7271  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -0.91148    0.03919 -23.257   &lt;2e-16 ***
## exposure     0.62844    0.04974  12.635   &lt;2e-16 ***
## sex         -0.57996    0.06956  -8.338   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 2674.1  on 1999  degrees of freedom
## Residual deviance: 2423.8  on 1997  degrees of freedom
## AIC: 2429.8
## 
## Number of Fisher Scoring iterations: 5</code></pre>
<p><br/n></p>
</div>
</div>
</div>
</div>
<div id="まとめ" class="section level1">
<h1>まとめ</h1>
<ul>
<li>2値のイベントの発生割合が大きい場合、オッズ比はリスク比よりも大きくなる (away from nullの程度が大きくなる)</li>
<li>オッズ比よりもリスク比の方が疫学的な関心が高いので、オッズ比とリスク比の乖離は問題となる。したがって、イベントが多い状況でロジスティック回帰を用いることは、慎重に考えるべき。</li>
<li>修正ポアソン回帰とlog-binomial regression (対数二項回帰) が代替候補。</li>
</ul>
<p><br/n>
<br/n>
<br/n></p>
</div>
<div id="参考文献" class="section level1">
<h1>参考文献</h1>
<ul>
<li>Zou, G. (2004). A modified poisson regression approach to prospective studies with binary data. American journal of epidemiology, 159(7), 702-706.</li>
<li>Petersen, M. R., &amp; Deddens, J. A. (2008). A comparison of two methods for estimating prevalence ratios. BMC medical research methodology, 8(1), 1-9.</li>
<li>Chen, W., Qian, L., Shi, J., &amp; Franklin, M. (2018). Comparing performance between log-binomial and robust Poisson regression models for estimating risk ratios under model misspecification. BMC medical research methodology, 18(1), 1-12.</li>
<li>Williamson, T., Eliasziw, M., &amp; Fick, G. H. (2013). Log-binomial models: exploring failed convergence. Emerging themes in epidemiology, 10(1), 1-10.</li>
</ul>
</div>


                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2022-08-05-riskratio-vs-oddsratio/" data-toggle="tooltip" data-placement="top" title="RiskRatio vs OddsRatio">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/2022-08-05-moveblog/" data-toggle="tooltip" data-placement="top" title="ブログを引っ越して、RStudio &#43; Github pages環境にした">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

                



            </div>

            
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/epidemiology" title="epidemiology">
                            epidemiology
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/power" title="power">
                            power
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    
                    
                    
                    

		            
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/toro-maguro/toro-maguro.github.io">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Sacoche" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Sacoche 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>














</body>
</html>
