---
title: powerの分布を返す関数、作った
author: 'toro'
date: '2022-08-05'
slug: []
categories:
  - Epidemiology
tags:
  - Epidemiology
  - power
output:
  html_document:
    highlight: "zenburn"
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<div id="powerの分布を考えてみよう" class="section level1">
<h1>powerの分布を考えてみよう</h1>
<p>モチベ: 様々な真の値に対するpowerの分布を計算したい。<br>
“真のリスク比” なんて神のみぞ知る値。powerの計算ってどれくらいrobustnessがあるのかな？という関心です。</p>
<ul>
<li>曝露変数: 0/1の2値、結果変数: 0/1の2値、のシチュエーション</li>
<li>真のリスク比を与えられるとpowerを返す関数を作り、リスク比に対するpowerの関係を可視化したい</li>
</ul>
<p>真の値と言っているのに、変動するのはおかしいんじゃ？という指摘はごもっともです。今回は単なる思考実験と思ってください。</p>
<p><br></p>
<p>NOTE: これはあくまで真の値を知っているときの話であって、標本値の話ではない</p>
<pre class="r"><code>pacman::p_load(pwr, tidyverse)

PlotPower_byRR &lt;- function(n_control, n_exposed, p_event_control, rr_min = 0.25, rr_max=3.0){
  
  # あるリスク比を定めると、powerを返す関数
  GetPower_byRR&lt;- function(risk_ratio){
    res &lt;- pwr.2p2n.test(h = ES.h(p1 = p_event_control, p2 = p_event_control*risk_ratio),
                         n1 = n_control, 
                         n2 = n_exposed,
                         sig.level = 0.05,
                         alternative = &quot;two.sided&quot;)
    power &lt;- res[[&quot;power&quot;]]
    return(power)
    }
  
  # イベント発生人数がN of participantsを超えるとエラーになるので、先に宣言しておく
  rr_max &lt;- ifelse(p_event_control*rr_max &gt;= 1, 1/p_event_control, rr_max) 
  
  scale_riskratio &lt;- seq(from=rr_min, to=rr_max, by=0.01)
  estimate_power &lt;- sapply(scale_riskratio, GetPower_byRR)
  
  df &lt;- data.frame(risk_ratio = scale_riskratio, power = estimate_power)
  # RR &lt; 1 でpower &gt;= 0.8となる、1に近い (最大の) RRを得る
  df_rr1 &lt;- df %&gt;% 
    filter(risk_ratio &lt; 1 &amp; power &gt;= 0.8) %&gt;% 
    arrange(power) # powerで昇順ソート
  power_080_1 &lt;- max(df_rr1$risk_ratio)

  # RR &gt; 1 でpower &gt;= 0.8となる、1に近い (最小の) RRを得る
  df_rr2 &lt;- df %&gt;% 
    filter(risk_ratio &gt; 1 &amp; power &gt;= 0.80) %&gt;% 
    arrange(power) # powerで昇順ソート
  power_080_2 &lt;- min(df_rr2$risk_ratio)
  
  # description
  cha1 &lt;- sprintf(&quot;number of participants: control group=%d&quot;, n_control)
  cha2 &lt;- sprintf(&quot;, exposure group=%d\n&quot;, n_exposed)
  cha3 &lt;- sprintf(&quot;true value of event probability in control group=%.2f&quot;, p_event_control)
  cha4 &lt;- sprintf(&quot;blue hashed line: the maximum value of risk ratio (within RR &lt;1) that achieved power ≥ 0.8=%.2f&quot;, power_080_1)
  cha5 &lt;- sprintf(&quot;\norange hashed line: the minimum value of risk ratio (within RR&gt;1) that achieved power ≥ 0.8=%.2f&quot;, power_080_2)
  
  subtitle = paste0(cha1, cha2, cha3)
  caption = paste0(cha4, cha5)
  
  # plot
  plot &lt;- ggplot(data = df, aes(x = risk_ratio, y = power)) + 
    geom_line() +
    geom_vline(xintercept = 1, colour = &quot;darkgray&quot;) + 
    geom_vline(xintercept = power_080_1, linetype = 2, colour = &quot;blue&quot;, alpha=0.8) + 
    geom_vline(xintercept = power_080_2, linetype = 2, colour = &quot;orange&quot;, alpha=0.8) + 
    geom_hline(yintercept = 0.8, colour = &quot;navy&quot;, alpha = 0.5) + 
    scale_y_continuous(breaks = seq(0, 1, 0.2)) + 
    labs(title = &quot;Relationship between risk ratio and power in binary-outcome studies&quot;,
        subtitle = subtitle,
        caption = caption) +
    xlab(&quot;risk ratio of exposed group compared to control group&quot;) +
    theme_bw() 
  return(plot)
}</code></pre>
</div>
<div id="関数の説明" class="section level1">
<h1>関数の説明</h1>
<p>引数は次の通り</p>
<ul>
<li>n_control: コントロール群の人数</li>
<li>n_exposed: 曝露群の人数</li>
<li>p_event_control: コントロール群でのイベント発生割合</li>
</ul>
<p>これらを入力すると、曝露のリスク比(横軸)に対するpower(縦軸)を返します。</p>
<div id="example1" class="section level2">
<h2>example1</h2>
<p>以降のセクションでは、リスク比 (RR) が1以上と考えます。(RR&lt;1でも同じ議論です)</p>
<p><br></p>
<p>コントロール群100人、曝露群100人で、曝露群でのイベント発生割合が25%とします。</p>
<p>真のRRが1.75ならpowerは0.80となり、「十分」と考えられます。
ただし、リスク比が1.5ならpower=0.50程度となります。かなりばらつくんですね。</p>
<pre class="r"><code>PlotPower_byRR(n_control = 100, 
               n_exposed = 100, 
               p_event_control = 0.25)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
</div>
<div id="example2" class="section level2">
<h2>example2</h2>
<p>人数を増やしてみましょう。今度はコントロール群200人、曝露グループ200人にします。</p>
<p>この場合、RR=1.75のときpowerはほぼ1 (100%) となります。人数が増えたので、当然です。
power=0.8を達成するリスク比は1.52となりました。</p>
<pre class="r"><code>PlotPower_byRR(n_control = 200, 
               n_exposed = 200, 
               p_event_control = 0.25)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
</div>
<div id="感想" class="section level1">
<h1>感想</h1>
<p>先行研究で、RR=1.75 [95%CI: 1.50-2.00] みたいな結果があったとしましょう。
同じような研究を実施する場合、この値を使ってpower計算することになると思います。</p>
<p>素直にRR=1.75という点推定値を使えば、example1の通り、各群100人合計200人でokです。
ただし、「RR=1.75が真の値である」という仮定を置いているだけで、実際には下振れしてしまうかもしれません。期待値的に点推定値を使うのはご尤もなんですが、真の値なんて知り得ない以上、ある程度ばらつきや分布を考えてもいいのかも？と思ってしまいました。例えば ±1σ の幅を持たせてあげるとか。</p>
<p>こういう話は研究のリソースや研究倫理も絡むのでもっと難しい議論になりそうですね。ひとまず勉強の感想でした。</p>
</div>
